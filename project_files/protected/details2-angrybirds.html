<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>The Angry Birds Movie - Details</title>
  <link rel="stylesheet" href="details.css">
</head>
<body>
  <div class="movie-detail-container">
    <div class="poster-section">
      <img src="/public/img/22.jpg" alt="Angry Birds" class="poster-image" />
      <button class="play-button" id="playButton">▶ Play</button>
      <a href="/public/movies/a.mp4" download="angrybirds.mp4" class="download-button">⬇ Download</a>
      <button class="watch-later-button" onclick="addToWatchLater()">+ Watch Later</button>
    </div>

    <div class="info-section">
      <h1 class="movie-title">The Angry Birds Movie</h1>
      <div class="sub-info">2016 • 1h 37min • PG</div>
      <div class="rating">6.3 <span class="star">⭐</span></div>

      <!-- Rating input -->
      <div class="rating-row" data-movie-id="2">
        <div class="rating-stars">
          <span data-star="1">★</span>
          <span data-star="2">★</span>
          <span data-star="3">★</span>
          <span data-star="4">★</span>
          <span data-star="5">★</span>
        </div>
        <button id="submitRatingBtn">Submit Rating</button>
      </div>

      <div class="tab-buttons">
        <button class="tab active" onclick="showTab('overview')">Overview</button>
        <button class="tab" onclick="showTab('trailers')">Trailers & More</button>
        <button class="tab" onclick="showTab('similar')">More Like This</button>
        <button class="tab" onclick="showTab('details')">Details</button>
      </div>

      <div class="tab-content">
        <div id="overview" class="tab-pane active">
          <p>
            When an island populated by happy, flightless birds is visited by mysterious green piggies,
            it's up to three unlikely outcasts to figure out what the pigs are up to.
          </p>
        </div>

        <div id="trailers" class="tab-pane">
          <iframe width="100%" height="315" src="https://www.youtube.com/embed/QRmKa7vvct4"
                  title="Angry Birds Trailer" frameborder="0" allowfullscreen></iframe>
        </div>

        <div id="similar" class="tab-pane">
          <div class="similar-movies">
            <img src="/public/img/15.jpg" alt="Rio">
            <img src="/public/img/16.jpg" alt="Minions">
            <img src="/public/img/17.jpg" alt="Madagascar">
          </div>
        </div>

        <div id="details" class="tab-pane">
          <ul class="details-list">
            <li><strong>Starring:</strong> Jason Sudeikis, Josh Gad, Danny McBride</li>
            <li><strong>Directed by:</strong> Clay Kaytis, Fergal Reilly</li>
            <li><strong>Produced by:</strong> John Cohen, Catherine Winder</li>
            <li><strong>Writers:</strong> Jon Vitti</li>
            <li><strong>Genres:</strong> Animation, Comedy, Adventure</li>
            <li><strong>Movie Characters:</strong> Red, Chuck, Bomb</li>
            <li><strong>Language:</strong> English</li>
            <li><strong>Production:</strong> Columbia Pictures, Rovio Animation</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <div id="videoPlayerContainer" style="display:none;">
    <video id="videoPlayer" controls></video>
    <button id="closeVideoBtn">Back</button>
  </div>

  <script>
    let userId = null;
    let selectedRating = 0;

    function showTab(tabId) {
      document.querySelectorAll('.tab-pane').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab').forEach(btn => btn.classList.remove('active'));
      document.getElementById(tabId).classList.add('active');
      event.target.classList.add('active');
    }

    // Star rating logic
    const ratingStars = document.querySelectorAll('.rating-stars span');
    const submitButton = document.getElementById('submitRatingBtn');

    ratingStars.forEach((star, index) => {
      star.addEventListener('click', () => {
        selectedRating = index + 1;
        ratingStars.forEach((s, i) => {
          s.classList.toggle('selected', i < selectedRating);
        });
      });
    });

    submitButton.addEventListener('click', () => {
      if (selectedRating > 0) {
        const movieId = document.querySelector('.rating-row').getAttribute('data-movie-id');

        fetch('/api/rate', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded'
          },
          body: `movie_id=${movieId}&rating=${selectedRating}`
        })
        .then(res => res.json())
        .then(data => {
          alert(data.success ? "✅ Rating submitted!" : "❌ Failed to save rating.");
        })
        .catch(() => {
          alert("❌ Network error.");
        });
      } else {
        alert("Please select a rating first!");
      }
    });

    // Watch Later
    fetch('/api/profile')
      .then(res => res.json())
      .then(data => {
        userId = data.user_id;
      })
      .catch(() => {
        alert("Please login first.");
        window.location.href = '/login.html';
      });

    function addToWatchLater() {
      const movieId = document.querySelector('.rating-row').getAttribute('data-movie-id');

      if (!userId || !movieId) {
        alert("User or movie not found.");
        return;
      }

      fetch('/watch-later', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ movieId, userId })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          alert('✅ Added to Watch Later!');
        } else if (data.message === 'DUPLICATE') {
          alert('⚠ Already added!');
        } else {
          alert('❌ Failed to add.');
        }
      });
    }

    // Video play
    const playButton = document.getElementById('playButton');
    const videoPlayer = document.getElementById('videoPlayer');
    const videoPlayerContainer = document.getElementById('videoPlayerContainer');
    const closeVideoBtn = document.getElementById('closeVideoBtn');



    playButton.addEventListener('click', () => {
  videoPlayer.src = '/public/movies/a.mp4'; 
  videoPlayerContainer.style.display = 'flex';
  videoPlayer.play();
  if (videoPlayer.requestFullscreen) {
    videoPlayer.requestFullscreen();
  }
});

    closeVideoBtn.addEventListener('click', () => {
      videoPlayer.pause();
      videoPlayer.currentTime = 0;
      videoPlayerContainer.style.display = 'none';
      if (document.exitFullscreen) {
        document.exitFullscreen();
      }
    });
  </script>
</body>
</html>

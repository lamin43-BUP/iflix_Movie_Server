<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Due Date - Movie Details</title>
  <link rel="stylesheet" href="details.css" />
</head>
<body>
  <div class="movie-detail-container">
    <div class="poster-section">
      <img src="/public/img/10.jpg" alt="Due Date" class="poster-image" />
      <button class="play-button" id="playButton">▶ Play</button>
      <a href="/public/movies/titanic.mp4" download="duedate.mp4" class="download-button">⬇ Download</a>
      <button class="watch-later-button" onclick="addToWatchLater()">+ Watch Later</button>
    </div>

    <div class="info-section">
      <h1 class="movie-title">Due Date</h1>
      <div class="sub-info">2010 • 1h 35min • R</div>
      <div class="rating">6.5 <span class="star">⭐</span></div>

      <div class="rating-row" data-movie-id="7">
        <div class="rating-stars">
          <span data-star="1">★</span>
          <span data-star="2">★</span>
          <span data-star="3">★</span>
          <span data-star="4">★</span>
          <span data-star="5">★</span>
        </div>
        <button id="submitRatingBtn">Submit Rating</button>
      </div>

      <div class="tab-buttons">
        <button class="tab active" onclick="showTab('overview', event)">Overview</button>
        <button class="tab" onclick="showTab('trailers', event)">Trailers & More</button>
        <button class="tab" onclick="showTab('similar', event)">More Like This</button>
        <button class="tab" onclick="showTab('details', event)">Details</button>
      </div>

      <div class="tab-content">
        <div id="overview" class="tab-pane active">
          <p>
            High-strung father-to-be Peter is forced to hitch a ride with aspiring actor Ethan on a road trip to make it to his child's birth — leading to wild misadventures across the country.
          </p>
        </div>

        <div id="trailers" class="tab-pane">
          <iframe width="100%" height="315" src="https://www.youtube.com/embed/dtUX3Vn6qZ0"
                  title="Due Date Trailer" frameborder="0" allowfullscreen></iframe>
        </div>

        <div id="similar" class="tab-pane">
          <div class="similar-movies">
            <img src="/public/img/12.jpg" alt="The Hangover">
            <img src="/public/img/13.jpg" alt="We're the Millers">
            <img src="/public/img/14.jpg" alt="Planes, Trains & Automobiles">
          </div>
        </div>

        <div id="details" class="tab-pane">
          <ul class="details-list">
            <li><strong>Starring:</strong> Robert Downey Jr., Zach Galifianakis, Michelle Monaghan</li>
            <li><strong>Directed by:</strong> Todd Phillips</li>
            <li><strong>Produced by:</strong> Todd Phillips, Daniel Goldberg, Susan Downey</li>
            <li><strong>Writers:</strong> Alan R. Cohen, Alan Freedland, Adam Sztykiel</li>
            <li><strong>Genres:</strong> Comedy, Drama</li>
            <li><strong>Movie Characters:</strong> Peter Highman, Ethan Tremblay</li>
            <li><strong>Language:</strong> English</li>
            <li><strong>Production:</strong> Warner Bros. Pictures</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <div id="videoPlayerContainer">
    <video id="videoPlayer" controls></video>
    <button id="closeVideoBtn">Back</button>
  </div>

  <script>
    let userId = null;

    fetch("/api/profile")
      .then(res => res.json())
      .then(data => {
        userId = data.user_id;
      })
      .catch(() => {
        alert("Please login first.");
        window.location.href = "/login.html";
      });

    function showTab(tabId, event) {
      document.querySelectorAll(".tab-pane").forEach(tab => tab.classList.remove("active"));
      document.querySelectorAll(".tab").forEach(btn => btn.classList.remove("active"));
      document.getElementById(tabId).classList.add("active");
      event.target.classList.add("active");
    }

    const ratingStars = document.querySelectorAll(".rating-stars span");
    const submitButton = document.getElementById("submitRatingBtn");
    let selectedRating = 0;

    ratingStars.forEach((star, index) => {
      star.addEventListener("click", () => {
        selectedRating = index + 1;
        ratingStars.forEach((s, i) => {
          s.classList.toggle("selected", i <= index);
        });
      });
    });

    submitButton.addEventListener("click", () => {
      if (!userId || selectedRating === 0) {
        alert("Please login and select a rating.");
        return;
      }

      const movieId = document.querySelector(".rating-row").getAttribute("data-movie-id");
      fetch("/submit-rating", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ movieId, userId, rating: selectedRating }),
      })
      .then(res => res.json())
      .then(data => {
        alert(data.success ? "✅ Rating submitted!" : "❌ Error submitting rating.");
      });
    });

    function addToWatchLater() {
      const movieId = document.querySelector(".rating-row").getAttribute("data-movie-id");
      if (!userId) {
        alert("Please login to add to Watch Later.");
        return;
      }

      fetch("/watch-later", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ movieId, userId }),
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          alert("✅ Movie added to Watch Later!");
        } else if (data.message === "DUPLICATE") {
          alert("⚠️ Already in Watch Later list!");
        } else {
          alert("❌ Error adding to Watch Later.");
        }
      });
    }

    const playButton = document.getElementById("playButton");
    const videoPlayer = document.getElementById("videoPlayer");
    const videoPlayerContainer = document.getElementById("videoPlayerContainer");
    const closeVideoBtn = document.getElementById("closeVideoBtn");

    playButton.addEventListener("click", () => {
      videoPlayer.src = "/public/movies/titanic.mp4";
      videoPlayerContainer.style.display = "flex";
      videoPlayer.play();
      if (videoPlayer.requestFullscreen) {
        videoPlayer.requestFullscreen();
      } else if (videoPlayer.webkitRequestFullscreen) {
        videoPlayer.webkitRequestFullscreen();
      } else if (videoPlayer.msRequestFullscreen) {
        videoPlayer.msRequestFullscreen();
      }
    });

    closeVideoBtn.addEventListener("click", () => {
      videoPlayer.pause();
      videoPlayer.currentTime = 0;
      videoPlayerContainer.style.display = "none";
      if (document.exitFullscreen) {
        document.exitFullscreen();
      } else if (document.webkitExitFullscreen) {
        document.webkitExitFullscreen();
      } else if (document.msExitFullscreen) {
        document.msExitFullscreen();
      }
    });
  </script>
</body>
</html>

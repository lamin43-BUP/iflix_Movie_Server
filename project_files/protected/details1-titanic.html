<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Titanic - Movie Details</title>
  <link rel="stylesheet" href="details.css">
</head>
<body>
  <div class="movie-detail-container">
    <div class="poster-section">
      <img src="/public/img/1.jpeg" alt="Titanic" class="poster-image" />
      <button class="play-button" id="playButton">▶ Play</button>
      <a href="/public/movies/t.mp4" download="titanic.mp4" class="download-button">⬇ Download</a>
      <button class="watch-later-button" onclick="addToWatchLater()">+ Watch Later</button>
    </div>

    <div class="info-section">
      <h1 class="movie-title">Titanic</h1>
      <div class="sub-info">1997 • 3h 14min • PG-13</div>
      <div class="rating">7.9 <span class="star">⭐</span></div>

      <div class="rating-row" data-movie-id="1">
        <div class="rating-stars">
          <span data-star="1">★</span>
          <span data-star="2">★</span>
          <span data-star="3">★</span>
          <span data-star="4">★</span>
          <span data-star="5">★</span>
        </div>
        <button id="submitRatingBtn">Submit Rating</button>
      </div>


      <div class="tab-buttons">
        <button class="tab active" onclick="showTab('overview')">Overview</button>
        <button class="tab" onclick="showTab('trailers')">Trailers & More</button>
        <button class="tab" onclick="showTab('similar')">More Like This</button>
        <button class="tab" onclick="showTab('details')">Details</button>
      </div>

      <div class="tab-content">
        <div id="overview" class="tab-pane active">
          <p>
            A seventeen-year-old aristocrat falls in love with a kind but poor artist aboard the luxurious, ill-fated R.M.S. Titanic.
          </p>
        </div>

        <div id="trailers" class="tab-pane">
          <iframe width="100%" height="315" src="https://www.youtube.com/embed/kVrqfYjkTdQ"
                  title="Titanic Trailer" frameborder="0" allowfullscreen></iframe>
        </div>

        <div id="similar" class="tab-pane">
          <div class="similar-movies">
            <img src="/public/img/12.jpg" alt="The Notebook">
            <img src="/public/img/13.jpg" alt="Romeo + Juliet">
            <img src="/public/img/14.jpg" alt="The Great Gatsby">
          </div>
        </div>

        <div id="details" class="tab-pane">
          <ul class="details-list">
            <li><strong>Starring:</strong> Leonardo DiCaprio, Kate Winslet, Billy Zane</li>
            <li><strong>Directed by:</strong> James Cameron</li>
            <li><strong>Produced by:</strong> James Cameron, Jon Landau</li>
            <li><strong>Writers:</strong> James Cameron</li>
            <li><strong>Genres:</strong> Romance, Drama</li>
            <li><strong>Movie Characters:</strong> Jack Dawson, Rose DeWitt Bukater, Cal Hockley</li>
            <li><strong>Language:</strong> English</li>
            <li><strong>Production:</strong> 20th Century Fox, Paramount Pictures</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <div id="videoPlayerContainer">
    <video id="videoPlayer" controls></video>
    <button id="closeVideoBtn">Back</button>
  </div>

  <script>
    let userId = null;
    function showTab(tabId) {
      document.querySelectorAll('.tab-pane').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab').forEach(btn => btn.classList.remove('active'));
      document.getElementById(tabId).classList.add('active');
      event.target.classList.add('active');
    }

    function playTrailer() {
    const video = document.getElementById('video-player');
    if (video.style.display === 'none') {
      video.style.display = 'block';
      video.play();
    } else {
      video.pause();
      video.style.display = 'none';
    }
  }



//ratings
// Selecting the stars and submit button
const ratingStars = document.querySelectorAll('.rating-stars span');
const submitButton = document.getElementById('submitRatingBtn');
let selectedRating = 0;

// Adding event listeners to each star
ratingStars.forEach((star, index) => {
  star.addEventListener('click', () => {
    selectedRating = index + 1; // rating between 1 and 5
    // Clear previous selections and add 'selected' class to clicked stars
    ratingStars.forEach((star, idx) => {
      if (idx <= index) {
        star.classList.add('selected');
      } else {
        star.classList.remove('selected');
      }
    });
  });
});

// Handling the submit button click
submitButton.addEventListener('click', () => {
  if (selectedRating > 0) {
    // Assuming a logged-in user with userId as 1
    const movieId = document.querySelector('.rating-row').getAttribute('data-movie-id');
     // Use actual user ID here after authentication
    
    // Sending the rating to the server
    fetch('/submit-rating', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        movieId: movieId,
        userId: userId,
        rating: selectedRating,
      }),
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert('Rating submitted successfully!');
      } else {
        alert('Error submitting rating.');
      }
    })
    .catch(err => console.error(err));
  } else {
    alert('Please select a rating.');
  }
});





// Watch later 

fetch('/api/profile')
    .then(res => res.json())
    .then(data => {
      userId = data.user_id;
    })
    .catch(() => {
      alert("Please login first.");
      window.location.href = '/login.html';
    });

  // This is the updated function
  function addToWatchLater() {
    const movieId = document.querySelector('.rating-row').getAttribute('data-movie-id');

    if (!userId || !movieId) {
      alert("User or movie not found.");
      return;
    }

    fetch('/watch-later', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ movieId, userId })
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        alert('✅ Movie added to Watch Later!');
      } else if (data.message === 'DUPLICATE') {
        alert('⚠️ Already in Watch Later list!');
      } else {
        alert('❌ Error adding to Watch Later.');
      }
    });
  }



  
  // video
   const playButton = document.getElementById('playButton');
    const videoPlayerContainer = document.getElementById('videoPlayerContainer');
    const videoPlayer = document.getElementById('videoPlayer');
    const closeVideoBtn = document.getElementById('closeVideoBtn');

    playButton.addEventListener('click', () => {
      // Set video source
      videoPlayer.src = '/public/movies/t.mp4';
      // Show the container
      videoPlayerContainer.style.display = 'flex';
      // Play video
      videoPlayer.play();
      // Request fullscreen if supported
      if (videoPlayer.requestFullscreen) {
        videoPlayer.requestFullscreen();
      } else if (videoPlayer.webkitRequestFullscreen) { 
        videoPlayer.webkitRequestFullscreen();
      } else if (videoPlayer.msRequestFullscreen) { 
        videoPlayer.msRequestFullscreen();
      }
    });

    closeVideoBtn.addEventListener('click', () => {
      // Pause and reset video
      videoPlayer.pause();
      videoPlayer.currentTime = 0;
      // Hide container
      videoPlayerContainer.style.display = 'none';
      // Exit fullscreen if needed
      if (document.exitFullscreen) {
        document.exitFullscreen();
      } else if (document.webkitExitFullscreen) { /* Safari */
        document.webkitExitFullscreen();
      } else if (document.msExitFullscreen) { /* IE11 */
        document.msExitFullscreen();
      }
    });

    document.querySelectorAll('.rating-stars span').forEach(star => {
  star.addEventListener('click', () => {
    const rating = star.dataset.star;
    const container = star.closest('.rating-stars');
    const movieId = container.dataset.movieId;

    // Send rating to backend
    fetch('/api/rate', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded'
      },
      body: `movie_id=${movieId}&rating=${rating}`
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        alert("✅ Rating saved: " + rating);
        highlightStars(container, rating);
      } else {
        alert("❌ Failed to save rating");
      }
    });
  });
});

// Optional: Update stars UI
function highlightStars(container, rating) {
  container.querySelectorAll('span').forEach(star => {
    star.textContent = star.dataset.star <= rating ? '★' : '☆';
  });
}
  </script>
</body>
</html>